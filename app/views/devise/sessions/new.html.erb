<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-auth.js"></script>
<!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-analytics.js"></script>
<!-- Initialize Firebase -->
<!-- <script src="/__/firebase/init.js"></script> -->
<div class="row bg-img">
  <div class="col-sm-5"></div>
  <div style="background-color: rgba(10,10,10,.68)" class="col-sm-2 item container">
    <h3 style="font-family: Lobster, serif"; align="center"><%= image_tag("user.png", width: '100px') %><br><br><a style="color: snow">LOGIN</a></h3><br><br>
    <%= form_for(resource, as: resource_name, url: session_path(resource_name)) do |f| %>
      <div class="input-group margT25">
        <span class="input-group-addon">
          <i class="glyphicon glyphicon-user"></i>
        </span>
        <%= f.email_field :email, autofocus: true, placeholder: "Username", class: "form-control" %>
      </div><br><br>
      <div class="input-group margT25">
        <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
        <%= f.password_field :password, autocomplete: "off", placeholder: "Password", class: "form-control" %>
      </div>
      <div class="text-center mt-4 mb-2">
        <div class="checkbox" style="color: snow">
          <% if devise_mapping.rememberable? -%>
            <%= f.check_box :remember_me %> Remember Me
          <% end -%>
        </div>
      </div>
      <div class="text-center mt-4 mb-2 ">
        <%= f.submit "Sign in", class: "btn btn-primary roundedCorner" %>
      </div>
    <% end %>
  </div>
</div>
<div id="loginScreen">
  <button id="login">login with google</button>
</div>
<div id="dashboard">
  <div id="userDetails"></div>
  <button id="logout">logout</button>
</div>

<script>
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  var firebaseConfig = {
    apiKey: "AIzaSyBBMCqN3-nI74SsdrgBxD5911fzYi33cJk",
    authDomain: "auth-408d5.firebaseapp.com",
    databaseURL: "https://auth-408d5.firebaseapp.com",
    projectId: "auth-408d5",
    storageBucket: "auth-408d5.appspot.com",
    messagingSenderId: "893699312924",
    appId: "1:893699312924:web:85966824cc5ae73583bed9"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  document.getElementById('dashboard').style.display="none"

  document.getElementById('login').addEventListener('click', googleLogin)
  document.getElementById('logout').addEventListener('click', logoutUser)

  let provider = new firebase.auth.GoogleAuthProvider();

  function googleLogin(){
    console.log("hello login")
    firebase.auth().signInWithPopup(provider).then((result) => {
      console.log(result)
      document.getElementById('loginScreen').style.display="none"
      document.getElementById('dashboard').style.display="block"
      showUserDetails(result.user)
      var userDetails = {email: result.user.email, displayName: result.user.displayName}
      var url = '/customers/google_auth_login/'
      console.log('======================');
      console.log(userDetails);
      $.ajax({
        url: url,
        data: userDetails,
        type: "GET",
        success: function (data,status,xhr) {// success callback function
          alert("login success.");
        },
        error: function (jqXhr, textStatus, errorMessage) {// error callback
          alert("error")
        }
      });
    }).catch((error) => {
      console.log(error)
    });
  }

  function showUserDetails(user){
    document.getElementById('userDetails').innerHTML = `
      <img src="${user.photoURL}" style="width:10%">
      <p>Name: ${user.displayName}</p>
      <p>Email: ${user.email}</p>
    `
  }

  function checkAuthState(){
    firebase.auth().onAuthStateChanged(user=>{
      if(user){
        console.log('login success')
        document.getElementById('loginScreen').style.display="none"
        document.getElementById('dashboard').style.display="block"
        showUserDetails(user)
      }else{

      }
    })
  }

  function logoutUser(){
    console.log("hello logout")
    firebase.auth().signOut().then(()=>{
      document.getElementById('loginScreen').style.display="block"
      document.getElementById('dashboard').style.display="none"
    }).catch(e=>{
      console.log(e)
    })
  }

  checkAuthState()
</script>